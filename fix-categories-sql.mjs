import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
dotenv.config();

const supabaseUrl = process.env.PUBLIC_SUPABASE_URL;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseServiceKey) {
    console.error('Error: PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY must be set in .env');
    process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseServiceKey);

async function fixCategoryTable() {
    console.log('Attempting to fix "categories" table schema...');

    const sql = `
        -- Create Categories Table if not exists
        CREATE TABLE IF NOT EXISTS public.categories (
            id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
            name text NOT NULL UNIQUE,
            slug text NOT NULL UNIQUE,
            description text,
            image_url text,
            meta_title text,
            meta_description text,
            created_at timestamp with time zone DEFAULT now() NOT NULL
        );

        -- Add columns if they are missing (for existing tables)
        ALTER TABLE public.categories ADD COLUMN IF NOT EXISTS description text;
        ALTER TABLE public.categories ADD COLUMN IF NOT EXISTS image_url text;
        ALTER TABLE public.categories ADD COLUMN IF NOT EXISTS meta_title text;
        ALTER TABLE public.categories ADD COLUMN IF NOT EXISTS meta_description text;

        -- Enable RLS
        ALTER TABLE public.categories ENABLE ROW LEVEL SECURITY;

        -- Policies
        DROP POLICY IF EXISTS "Enable public read access for categories" ON public.categories;
        CREATE POLICY "Enable public read access for categories" ON public.categories FOR SELECT USING (true);
        
        DROP POLICY IF EXISTS "Enable all access for service role" ON public.categories;
        CREATE POLICY "Enable all access for service role" ON public.categories USING (true);
    `;

    console.log('Please copy and run this SQL in your Supabase SQL Editor:');
    console.log('----------------------------------------------------');
    console.log(sql);
    console.log('----------------------------------------------------');
}

fixCategoryTable();
