---
// Dynamic product page - fetches from Supabase
export const prerender = false;

import MainLayout from "@/layouts/MainLayout.astro";
import { SITE } from "@data/constants";
import { supabase } from "@/lib/db";

const { id } = Astro.params;

const { data: product, error } = await supabase
  .from('products')
  .select('*')
  .eq('slug', id)
  .single();

let categorySlug = null;
if (product?.category) {
  const { data: catData } = await supabase
    .from('categories')
    .select('slug')
    .eq('name', product.category)
    .single();
  categorySlug = catData?.slug;
}

if (error || !product) {
  return Astro.redirect('/products');
}

const pageTitle = `${product.title} | ${SITE.title}`;
const metaDescription = product.description || `Shop ${product.title} - Authentic handcrafted Peshawari Chappal`;
const ogTitle = `${product.title} | Handcrafted Leather Sandals`;

const sizes = Array.isArray(product.sizes) ? product.sizes : [];
const galleryImages = Array.isArray(product.gallery_images) ? product.gallery_images : [];

// Combine main image with gallery for all images
const allImages = [product.main_image, ...galleryImages].filter(Boolean);
---

<MainLayout
  title={pageTitle}
  customDescription={metaDescription}
  customOgTitle={ogTitle}
  structuredData={{
    "@context": "https://schema.org",
    "@type": "Product",
    "@id": `https://peshawarichappal.store/products/${product.slug}`,
    name: product.title,
    description: product.description,
    image: product.main_image,
    brand: { "@type": "Brand", name: "Peshawari Chappal" },
    offers: {
      "@type": "Offer",
      price: product.price,
      priceCurrency: "PKR",
      availability: product.in_stock ? "https://schema.org/InStock" : "https://schema.org/OutOfStock",
    },
  }}
>
  <section class="bg-white dark:bg-neutral-900 overflow-x-hidden">
    <div class="mx-auto max-w-7xl px-3 py-6 sm:px-6 lg:px-8 lg:py-16">
      
      <!-- Breadcrumb -->
      <nav class="mb-4 sm:mb-8 w-full overflow-x-auto">
        <ol class="flex items-center gap-1 sm:gap-2 text-xs sm:text-sm text-neutral-500 dark:text-neutral-400 whitespace-nowrap">
          <li><a href="/" class="hover:text-orange-500">Home</a></li>
          <li>/</li>
          <li><a href="/products" class="hover:text-orange-500">Products</a></li>
          {product.category && (
            <>
              <li>/</li>
              <li><a href={`/categories/${categorySlug || product.category.toLowerCase().replace(/[^a-z0-9]+/g, '-')}`} class="hover:text-orange-500 truncate">{product.category}</a></li>
            </>
          )}
          <li>/</li>
          <li class="text-neutral-900 dark:text-white font-medium truncate">{product.title}</li>
        </ol>
      </nav>

      <div class="grid gap-5 sm:gap-8 lg:grid-cols-2 lg:gap-12">
        
        <!-- Left: Product Images -->
        <div class="space-y-3 sm:space-y-4">
          <!-- Main Image -->
          <div class="relative aspect-square overflow-hidden rounded-2xl sm:rounded-3xl bg-neutral-100 dark:bg-neutral-800 shadow-lg sm:shadow-2xl lg:max-h-[520px]">
            <img
              id="main-image"
              src={product.main_image || '/placeholder.jpg'}
              alt={product.title}
              class="h-full w-full object-cover"
            />
            {/* Discount Badge */}
            {product.original_price && parseInt(product.original_price) > parseInt(product.price) && (
              <div class="absolute top-4 right-4">
                <span class="rounded-full bg-orange-500 px-3 py-1 text-xs font-bold text-white shadow-lg">
                  {Math.round((1 - parseInt(product.price) / parseInt(product.original_price)) * 100)}% OFF
                </span>
              </div>
            )}
          </div>

          <!-- Thumbnail Gallery -->
          {allImages.length > 1 && (
            <div class="flex gap-2 sm:gap-3 overflow-x-auto pb-2" id="thumbnail-gallery">
              {allImages.map((img: string, i: number) => (
                <button
                  class={`thumb-btn flex-shrink-0 w-16 h-16 sm:w-20 sm:h-20 rounded-lg sm:rounded-xl overflow-hidden border-2 transition-all duration-200 ${i === 0 ? 'border-orange-500 ring-2 ring-orange-500/30' : 'border-neutral-200 dark:border-neutral-700 hover:border-orange-300'}`}
                  data-src={img}
                  data-index={i}
                >
                  <img src={img} alt={`View ${i + 1}`} class="w-full h-full object-cover" loading="lazy" />
                </button>
              ))}
            </div>
          )}
        </div>

        <!-- Right: Product Details -->
        <div class="flex flex-col min-w-0">
          <!-- Category Badge -->
          {product.category && (
            <div class="mb-2 sm:mb-4">
              <a 
                href={`/categories/${categorySlug || product.category.toLowerCase().replace(/[^a-z0-9]+/g, '-')}`}
                class="inline-block px-3 py-1 text-xs font-bold uppercase tracking-wider text-orange-600 bg-orange-100 dark:bg-orange-900/30 dark:text-orange-400 rounded-lg hover:bg-orange-200 dark:hover:bg-orange-900/50 transition-colors"
              >
                {product.category}
              </a>
            </div>
          )}
          <!-- Title -->
          <h1 class="text-xl font-bold text-neutral-900 dark:text-white sm:text-3xl lg:text-4xl leading-tight mt-1 sm:mt-2">
            {product.title}
          </h1>

          <!-- Description -->
          <p class="mt-1 sm:mt-2 text-sm sm:text-base lg:text-lg text-neutral-600 dark:text-neutral-300 leading-relaxed">
            {product.description}
          </p>

          <!-- Price Section -->
          <div class="mt-2 sm:mt-4 flex items-baseline gap-2 sm:gap-3 flex-wrap">
            <span class="text-2xl sm:text-3xl lg:text-4xl font-bold text-orange-600 dark:text-orange-500">
              Rs {product.price?.toLocaleString()}
            </span>
            {product.original_price && (
              <>
                <span class="text-lg sm:text-xl text-neutral-400 line-through">
                  Rs {product.original_price?.toLocaleString()}
                </span>
                <span class="rounded-lg bg-green-100 px-3 py-1 text-xs sm:text-sm font-semibold text-green-700 dark:bg-green-900/30 dark:text-green-400">
                  Save Rs {(product.original_price - product.price).toLocaleString()}
                </span>
              </>
            )}
          </div>

          <!-- Divider -->
          <hr class="my-2 sm:my-4 border-neutral-200 dark:border-neutral-700" />

          <!-- Size Selection -->
          {sizes.length > 0 && (
            <div class="mt-2 sm:mt-3">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold text-neutral-900 dark:text-white uppercase tracking-wide">Select Size (UK)</h3>
                <span id="selected-size-display" class="text-sm text-orange-600 font-medium">Size: {sizes[0]}</span>
              </div>
              <div class="flex flex-wrap gap-2" id="size-selector">
                {sizes.map((size: string, index: number) => (
                  <button
                    class={`size-option w-11 h-11 sm:w-14 sm:h-14 rounded-lg sm:rounded-xl border-2 text-xs sm:text-sm font-bold transition-all duration-200 ${index === 0 ? 'border-orange-500 bg-orange-500 text-white shadow-lg shadow-orange-500/30' : 'border-neutral-200 text-neutral-700 hover:border-orange-300 dark:border-neutral-600 dark:text-neutral-300 dark:hover:border-orange-500'}`}
                    data-size={size}
                  >
                    {size}
                  </button>
                ))}
              </div>
            </div>
          )}

          <!-- Action Buttons -->
          <div class="mt-3 sm:mt-6 space-y-2 sm:space-y-3">
            <!-- Row 1: Add to Cart + WhatsApp -->
            <div class="flex gap-2 sm:gap-3">
              <button
                id="add-to-cart-btn"
                class="flex-1 rounded-2xl bg-gradient-to-r from-orange-500 to-orange-600 px-4 sm:px-6 py-3 sm:py-4 text-center text-sm sm:text-base font-bold text-white shadow-lg shadow-orange-500/30 transition-all hover:shadow-xl sm:hover:scale-[1.02] active:scale-[0.98]"
                data-product-id={product.id}
                data-product-title={product.title}
                data-product-price={product.price}
                data-product-image={product.main_image}
              >
                <span class="flex items-center justify-center gap-2">
                  <svg class="h-4 sm:h-5 w-4 sm:w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z" />
                  </svg>
                  <span class="hidden sm:inline">Add to Cart</span>
                  <span class="sm:hidden">Cart</span>
                </span>
              </button>
              <a
                href={`https://wa.me/923018768666?text=Hi! I want to order ${encodeURIComponent(product.title)} (Rs ${product.price})`}
                target="_blank"
                class="flex-1 rounded-2xl bg-[#25D366] px-4 sm:px-6 py-3 sm:py-4 text-center text-sm sm:text-base font-bold text-white shadow-lg shadow-[#25D366]/40 transition-all hover:bg-[#20ba5a] hover:shadow-xl sm:hover:scale-[1.02] active:scale-[0.98]"
              >
                <span class="flex items-center justify-center gap-2">
                  <svg class="h-4 sm:h-5 w-4 sm:w-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                  </svg>
                  <span class="hidden sm:inline">Order via WhatsApp</span>
                  <span class="sm:hidden">WhatsApp</span>
                </span>
              </a>
            </div>
            <!-- Row 2: Watch Video -->
            {product.video_url && (
              <button
                id="open-video-btn"
                data-video-url={product.video_url}
                class="w-full flex items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-red-500 to-red-600 px-6 py-3 sm:py-3.5 text-sm sm:text-base font-semibold text-white shadow-lg shadow-red-500/25 transition-all hover:shadow-xl sm:hover:scale-[1.02] active:scale-[0.98] cursor-pointer"
              >
                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                </svg>
                Watch HD Video
              </button>
            )}
          </div>

          <!-- Features Grid -->
          <div class="mt-4 sm:mt-8 grid grid-cols-2 gap-2 sm:gap-3">
            <div class="flex items-center gap-2 sm:gap-3 rounded-lg sm:rounded-xl bg-neutral-50 dark:bg-neutral-800 p-3 sm:p-4">
              <div class="flex h-8 w-8 sm:h-10 sm:w-10 items-center justify-center rounded-full bg-orange-100 dark:bg-orange-900/30 flex-shrink-0">
                <svg class="h-4 w-4 sm:h-5 sm:w-5 text-orange-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <span class="text-xs sm:text-sm font-medium text-neutral-700 dark:text-neutral-300">Genuine Leather</span>
            </div>
            <div class="flex items-center gap-2 sm:gap-3 rounded-lg sm:rounded-xl bg-neutral-50 dark:bg-neutral-800 p-3 sm:p-4">
              <div class="flex h-8 w-8 sm:h-10 sm:w-10 items-center justify-center rounded-full bg-orange-100 dark:bg-orange-900/30 flex-shrink-0">
                <svg class="h-4 w-4 sm:h-5 sm:w-5 text-orange-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12" />
                </svg>
              </div>
              <span class="text-xs sm:text-sm font-medium text-neutral-700 dark:text-neutral-300">Free Shipping</span>
            </div>
            <div class="flex items-center gap-2 sm:gap-3 rounded-lg sm:rounded-xl bg-neutral-50 dark:bg-neutral-800 p-3 sm:p-4">
              <div class="flex h-8 w-8 sm:h-10 sm:w-10 items-center justify-center rounded-full bg-orange-100 dark:bg-orange-900/30 flex-shrink-0">
                <svg class="h-4 w-4 sm:h-5 sm:w-5 text-orange-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
              </div>
              <span class="text-xs sm:text-sm font-medium text-neutral-700 dark:text-neutral-300">Easy Returns</span>
            </div>
            <div class="flex items-center gap-2 sm:gap-3 rounded-lg sm:rounded-xl bg-neutral-50 dark:bg-neutral-800 p-3 sm:p-4">
              <div class="flex h-8 w-8 sm:h-10 sm:w-10 items-center justify-center rounded-full bg-orange-100 dark:bg-orange-900/30 flex-shrink-0">
                <svg class="h-4 w-4 sm:h-5 sm:w-5 text-orange-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" />
                </svg>
              </div>
              <span class="text-xs sm:text-sm font-medium text-neutral-700 dark:text-neutral-300">Handcrafted</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Product Details Section -->
  {product.content && (
    <section class="bg-neutral-50 dark:bg-neutral-800/50">
      <div class="mx-auto max-w-4xl px-4 py-16 sm:px-6 lg:px-8">
        <h2 class="text-2xl font-bold text-neutral-900 dark:text-white mb-6">About This Product</h2>
        <div class="prose prose-neutral dark:prose-invert max-w-none text-lg leading-relaxed">
          {product.content}
        </div>
      </div>
    </section>
  )}

  <!-- Size Guide -->
  <section class="bg-white dark:bg-neutral-900">
    <div class="mx-auto max-w-4xl px-4 py-16 sm:px-6 lg:px-8">
      <h2 class="text-2xl font-bold text-neutral-900 dark:text-white mb-6">Size Guide</h2>
      <div class="overflow-hidden rounded-2xl border border-neutral-200 dark:border-neutral-700">
        <table class="w-full text-sm">
          <thead class="bg-neutral-100 dark:bg-neutral-800">
            <tr>
              <th class="px-6 py-4 text-left font-semibold text-neutral-900 dark:text-white">UK</th>
              <th class="px-6 py-4 text-left font-semibold text-neutral-900 dark:text-white">US</th>
              <th class="px-6 py-4 text-left font-semibold text-neutral-900 dark:text-white">EU</th>
              <th class="px-6 py-4 text-left font-semibold text-neutral-900 dark:text-white">Foot Length</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-neutral-200 dark:divide-neutral-700">
            <tr class="hover:bg-neutral-50 dark:hover:bg-neutral-800/50"><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">7</td><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">8</td><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">41</td><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">25.4 cm</td></tr>
            <tr class="hover:bg-neutral-50 dark:hover:bg-neutral-800/50"><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">8</td><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">9</td><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">42</td><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">26.0 cm</td></tr>
            <tr class="hover:bg-neutral-50 dark:hover:bg-neutral-800/50"><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">9</td><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">10</td><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">43</td><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">26.7 cm</td></tr>
            <tr class="hover:bg-neutral-50 dark:hover:bg-neutral-800/50"><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">10</td><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">11</td><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">44</td><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">27.3 cm</td></tr>
            <tr class="hover:bg-neutral-50 dark:hover:bg-neutral-800/50"><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">11</td><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">12</td><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">45</td><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">28.0 cm</td></tr>
            <tr class="hover:bg-neutral-50 dark:hover:bg-neutral-800/50"><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">12</td><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">13</td><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">46</td><td class="px-6 py-4 text-neutral-600 dark:text-neutral-300">28.6 cm</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Video Modal -->
  {product.video_url && (
    <div id="video-modal" class="video-modal" aria-hidden="true">
      <div class="video-modal__backdrop" id="video-modal-backdrop"></div>
      <div class="video-modal__container">
        <div class="video-modal__header">
          <h3 class="video-modal__title">{product.title}</h3>
          <button id="close-video-btn" class="video-modal__close" aria-label="Close video">
            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="video-modal__body" id="video-modal-body">
          <!-- Video content injected by JS -->
        </div>
      </div>
    </div>
  )}

  <style>
    .video-modal {
      position: fixed;
      inset: 0;
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .video-modal.is-open {
      opacity: 1;
      visibility: visible;
    }
    .video-modal__backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .video-modal__container {
      position: relative;
      width: 100%;
      max-width: 56rem;
      background: #1a1a1a;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
      transform: scale(0.92) translateY(20px);
      transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .video-modal.is-open .video-modal__container {
      transform: scale(1) translateY(0);
    }
    .video-modal__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.875rem 1.25rem;
      border-bottom: 1px solid #2a2a2a;
    }
    .video-modal__title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #e5e5e5;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-right: 1rem;
    }
    .video-modal__close {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 2rem;
      height: 2rem;
      border-radius: 0.5rem;
      background: #2a2a2a;
      color: #a3a3a3;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    .video-modal__close:hover {
      background: #ef4444;
      color: #fff;
    }
    .video-modal__body {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #000;
    }
    .video-modal__body iframe,
    .video-modal__body video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: none;
    }
    @media (max-width: 640px) {
      .video-modal {
        padding: 0;
        align-items: flex-end;
      }
      .video-modal__container {
        max-width: 100%;
        border-radius: 1rem 1rem 0 0;
        transform: translateY(100%);
      }
      .video-modal.is-open .video-modal__container {
        transform: translateY(0);
      }
      .video-modal__body {
        aspect-ratio: 16 / 10;
      }
    }
  </style>
</MainLayout>

<script>
  import { addToCart } from "@stores/cartStore";

  // Handle gallery thumbnails
  const mainImage = document.getElementById('main-image') as HTMLImageElement;
  const thumbButtons = document.querySelectorAll('.thumb-btn');
  const sizeButtons = document.querySelectorAll('.size-option');
  const sizeDisplay = document.getElementById('selected-size-display');
  const addToCartBtn = document.getElementById('add-to-cart-btn');

  let selectedSize = sizeButtons.length > 0 ? sizeButtons[0].getAttribute('data-size') : '';

  thumbButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const imgSrc = btn.getAttribute('data-src');
      if (mainImage && imgSrc) mainImage.src = imgSrc;
      
      thumbButtons.forEach(b => {
        b.classList.remove('border-orange-500', 'ring-2', 'ring-orange-500/30');
        b.classList.add('border-neutral-200');
      });
      btn.classList.add('border-orange-500', 'ring-2', 'ring-orange-500/30');
      btn.classList.remove('border-neutral-200');
    });
  });

  sizeButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      selectedSize = btn.getAttribute('data-size') || '';
      if (sizeDisplay) sizeDisplay.textContent = 'Size: ' + selectedSize;
      
      sizeButtons.forEach(b => {
        b.classList.remove('border-orange-500', 'bg-orange-500', 'text-white', 'shadow-lg', 'shadow-orange-500/30');
        b.classList.add('border-neutral-200', 'text-neutral-700');
      });
      btn.classList.add('border-orange-500', 'bg-orange-500', 'text-white', 'shadow-lg', 'shadow-orange-500/30');
      btn.classList.remove('border-neutral-200', 'text-neutral-700');
    });
  });

  if (addToCartBtn) {
    addToCartBtn.addEventListener('click', () => {
      const productId = addToCartBtn.getAttribute('data-product-id')!;
      const productTitle = addToCartBtn.getAttribute('data-product-title')!;
      const productPrice = parseFloat(addToCartBtn.getAttribute('data-product-price') || '0');
      const productImage = addToCartBtn.getAttribute('data-product-image')!;

      if (!selectedSize && sizeButtons.length > 0) {
        alert('Please select a size');
        return;
      }

      addToCart({
        id: productId,
        productId: productId,
        title: productTitle,
        price: productPrice,
        image: productImage,
        size: selectedSize || undefined,
      });

      // Show the cart drawer (assuming preline or similar is used for hs-overlay)
      // @ts-ignore
      if (window.HSOverlay) {
        // @ts-ignore
        window.HSOverlay.open('#cart-drawer');
      }

      // Visual feedback
      const originalContent = addToCartBtn.innerHTML;
      addToCartBtn.innerHTML = '<span class="flex items-center justify-center gap-2"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>Added!</span>';
      (addToCartBtn as HTMLElement).style.background = 'linear-gradient(to right, #22c55e, #16a34a)';
      
      setTimeout(() => {
        addToCartBtn.innerHTML = originalContent;
        (addToCartBtn as HTMLElement).style.background = '';
      }, 1500);
    });
  }

  // ========================
  // VIDEO MODAL
  // ========================
  const openVideoBtn = document.getElementById('open-video-btn');
  const videoModal = document.getElementById('video-modal');
  const videoModalBody = document.getElementById('video-modal-body');
  const closeVideoBtn = document.getElementById('close-video-btn');
  const videoBackdrop = document.getElementById('video-modal-backdrop');

  function getEmbedUrl(url: string): { type: 'iframe' | 'video'; src: string } {
    // YouTube regular: youtube.com/watch?v=ID or youtu.be/ID
    const ytRegex = /(?:youtube\.com\/(?:watch\?v=|embed\/|v\/)|youtu\.be\/([\w-]+))/;
    const ytMatch = url.match(ytRegex);
    if (ytMatch) {
      const videoId = ytMatch[1] || new URL(url).searchParams.get('v');
      return { type: 'iframe', src: `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0` };
    }

    // YouTube Shorts: youtube.com/shorts/ID
    const ytShortsRegex = /youtube\.com\/shorts\/([\w-]+)/;
    const ytShortsMatch = url.match(ytShortsRegex);
    if (ytShortsMatch) {
      return { type: 'iframe', src: `https://www.youtube.com/embed/${ytShortsMatch[1]}?autoplay=1&rel=0` };
    }

    // Vimeo: vimeo.com/ID
    const vimeoRegex = /vimeo\.com\/(\d+)/;
    const vimeoMatch = url.match(vimeoRegex);
    if (vimeoMatch) {
      return { type: 'iframe', src: `https://player.vimeo.com/video/${vimeoMatch[1]}?autoplay=1` };
    }

    // Dailymotion: dailymotion.com/video/ID
    const dmRegex = /dailymotion\.com\/video\/([\w]+)/;
    const dmMatch = url.match(dmRegex);
    if (dmMatch) {
      return { type: 'iframe', src: `https://www.dailymotion.com/embed/video/${dmMatch[1]}?autoplay=1` };
    }

    // Direct video file (mp4, webm, ogg, mov)
    if (/\.(mp4|webm|ogg|mov)(\?.*)?$/i.test(url)) {
      return { type: 'video', src: url };
    }

    // Fallback: try iframe embed
    return { type: 'iframe', src: url };
  }

  function openModal() {
    if (!openVideoBtn || !videoModal || !videoModalBody) return;
    const videoUrl = openVideoBtn.getAttribute('data-video-url') || '';
    const embed = getEmbedUrl(videoUrl);

    if (embed.type === 'video') {
      videoModalBody.innerHTML = `<video controls autoplay playsinline><source src="${embed.src}" type="video/mp4">Your browser does not support the video tag.</video>`;
    } else {
      videoModalBody.innerHTML = `<iframe src="${embed.src}" allow="autoplay; fullscreen; encrypted-media; picture-in-picture" allowfullscreen></iframe>`;
    }

    videoModal.classList.add('is-open');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    if (!videoModal || !videoModalBody) return;
    videoModal.classList.remove('is-open');
    document.body.style.overflow = '';
    // Stop playback after animation
    setTimeout(() => { videoModalBody.innerHTML = ''; }, 350);
  }

  openVideoBtn?.addEventListener('click', openModal);
  closeVideoBtn?.addEventListener('click', closeModal);
  videoBackdrop?.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && videoModal?.classList.contains('is-open')) closeModal();
  });
</script>

