---
// Dynamic product page - fetches from Supabase
export const prerender = false;

import MainLayout from "@/layouts/MainLayout.astro";
import { SITE } from "@data/constants";
import { supabase } from "@/lib/db";

// Get product slug from URL
const { id } = Astro.params;

// Fetch product from Supabase
const { data: product, error } = await supabase
  .from('products')
  .select('*')
  .eq('slug', id)
  .single();

// Handle not found
if (error || !product) {
  return Astro.redirect('/products');
}

const pageTitle = `${product.title} | ${SITE.title}`;
const metaDescription = product.description || `Shop ${product.title} - Authentic handcrafted Peshawari Chappal`;
const ogTitle = `${product.title} | Handcrafted Leather Sandals`;

// Parse arrays/objects if they're strings
const sizes = Array.isArray(product.sizes) ? product.sizes : [];
const galleryImages = Array.isArray(product.gallery_images) ? product.gallery_images : [];
const colors = Array.isArray(product.colors) ? product.colors : [];
const features = Array.isArray(product.features) ? product.features : [];
---

<MainLayout
  title={pageTitle}
  customDescription={metaDescription}
  customOgTitle={ogTitle}
  structuredData={{
    "@context": "https://schema.org",
    "@type": "Product",
    "@id": `https://peshawarichappal.store/products/${product.slug}`,
    name: product.title,
    description: product.description,
    image: product.main_image,
    brand: {
      "@type": "Brand",
      name: "Peshawari Chappal",
    },
    offers: {
      "@type": "Offer",
      price: product.price,
      priceCurrency: "PKR",
      availability: product.in_stock ? "https://schema.org/InStock" : "https://schema.org/OutOfStock",
    },
  }}
>
  <section class="relative overflow-hidden bg-gradient-to-br from-neutral-50 via-white to-neutral-50 dark:from-neutral-900 dark:via-neutral-800 dark:to-neutral-900">
    <div class="absolute inset-0 opacity-5">
      <svg class="h-full w-full" viewBox="0 0 100 100" preserveAspectRatio="none">
        <defs>
          <pattern id="product-pattern" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
            <circle cx="10" cy="10" r="1" fill="currentColor" />
          </pattern>
        </defs>
        <rect width="100%" height="100%" fill="url(#product-pattern)" />
      </svg>
    </div>

    <div class="relative mx-auto max-w-7xl px-4 py-16 sm:px-6 lg:px-8 lg:py-24">
      <div class="grid gap-12 lg:grid-cols-2 lg:gap-16">
        <!-- Product Images -->
        <div class="space-y-4">
          <div class="aspect-square overflow-hidden rounded-2xl bg-neutral-100 dark:bg-neutral-800">
            <img
              id="main-product-image"
              src={product.main_image || '/placeholder.jpg'}
              alt={product.title}
              class="h-full w-full object-cover transition-all duration-500"
            />
          </div>
          
          {/* Thumbnail Gallery */}
          {galleryImages.length > 0 && (
            <div class="flex gap-3 overflow-x-auto pb-2">
              <button
                class="thumbnail-btn flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden border-2 border-orange-500 opacity-100"
                data-image={product.main_image}
              >
                <img src={product.main_image} alt="Main" class="w-full h-full object-cover" />
              </button>
              {galleryImages.map((img: string, i: number) => (
                <button
                  class="thumbnail-btn flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden border-2 border-transparent opacity-70 hover:opacity-100 transition-all"
                  data-image={img}
                >
                  <img src={img} alt={`Gallery ${i + 1}`} class="w-full h-full object-cover" />
                </button>
              ))}
            </div>
          )}
        </div>

        <!-- Product Info -->
        <div class="flex flex-col justify-center">
          <div class="mb-4">
            <span class="inline-block rounded-full bg-orange-100 px-3 py-1 text-sm font-medium text-orange-700 dark:bg-orange-900/30 dark:text-orange-400">
              {product.in_stock ? 'In Stock' : 'Out of Stock'}
            </span>
          </div>

          <h1 class="text-3xl font-bold text-neutral-900 dark:text-white sm:text-4xl lg:text-5xl">
            {product.title}
          </h1>

          <p class="mt-4 text-lg text-neutral-600 dark:text-neutral-300">
            {product.description}
          </p>

          <!-- Price -->
          <div class="mt-6 flex items-baseline gap-4">
            <span class="text-4xl font-bold text-orange-600">
              Rs {product.price?.toLocaleString()}
            </span>
            {product.original_price && (
              <span class="text-xl text-neutral-400 line-through">
                Rs {product.original_price?.toLocaleString()}
              </span>
            )}
            {product.original_price && (
              <span class="rounded-full bg-green-100 px-3 py-1 text-sm font-medium text-green-700 dark:bg-green-900/30 dark:text-green-400">
                Save Rs {(product.original_price - product.price).toLocaleString()}
              </span>
            )}
          </div>

          <!-- Sizes -->
          {sizes.length > 0 && (
            <div class="mt-8">
              <h3 class="text-sm font-semibold text-neutral-900 dark:text-white mb-3">Select Size</h3>
              <div class="flex flex-wrap gap-2">
                {sizes.map((size: string, index: number) => (
                  <button
                    class={`size-btn px-4 py-2 rounded-lg border-2 text-sm font-medium transition-all ${index === 0 ? 'border-orange-500 bg-orange-50 text-orange-700 dark:bg-orange-900/20 dark:text-orange-400' : 'border-neutral-200 text-neutral-700 hover:border-orange-300 dark:border-neutral-600 dark:text-neutral-300'}`}
                    data-size={size}
                  >
                    {size}
                  </button>
                ))}
              </div>
            </div>
          )}

          <!-- Add to Cart -->
          <div class="mt-8 flex flex-col gap-4 sm:flex-row">
            <button
              id="add-to-cart"
              class="flex-1 rounded-xl bg-gradient-to-r from-orange-500 to-orange-600 px-8 py-4 text-center font-bold text-white shadow-lg shadow-orange-500/25 transition-all hover:from-orange-600 hover:to-orange-700 hover:shadow-xl"
              data-product-id={product.id}
              data-product-title={product.title}
              data-product-price={product.price}
              data-product-image={product.main_image}
            >
              Add to Cart
            </button>
            <a
              href={`https://wa.me/923018768666?text=Hi! I'm interested in ${encodeURIComponent(product.title)} (Rs ${product.price})`}
              target="_blank"
              class="flex items-center justify-center gap-2 rounded-xl border-2 border-green-500 bg-green-50 px-8 py-4 font-bold text-green-700 transition-all hover:bg-green-100 dark:bg-green-900/20 dark:text-green-400"
            >
              <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
              </svg>
              Order via WhatsApp
            </a>
          </div>

          <!-- Features -->
          <div class="mt-8 grid grid-cols-2 gap-4">
            <div class="flex items-center gap-3 rounded-lg bg-neutral-100 p-3 dark:bg-neutral-800">
              <svg class="h-6 w-6 text-orange-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span class="text-sm font-medium text-neutral-700 dark:text-neutral-300">100% Genuine Leather</span>
            </div>
            <div class="flex items-center gap-3 rounded-lg bg-neutral-100 p-3 dark:bg-neutral-800">
              <svg class="h-6 w-6 text-orange-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12" />
              </svg>
              <span class="text-sm font-medium text-neutral-700 dark:text-neutral-300">Free Shipping</span>
            </div>
            <div class="flex items-center gap-3 rounded-lg bg-neutral-100 p-3 dark:bg-neutral-800">
              <svg class="h-6 w-6 text-orange-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
              </svg>
              <span class="text-sm font-medium text-neutral-700 dark:text-neutral-300">Easy Returns</span>
            </div>
            <div class="flex items-center gap-3 rounded-lg bg-neutral-100 p-3 dark:bg-neutral-800">
              <svg class="h-6 w-6 text-orange-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
              </svg>
              <span class="text-sm font-medium text-neutral-700 dark:text-neutral-300">Handcrafted</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Product Description Section -->
  {product.content && (
    <section class="mx-auto max-w-4xl px-4 py-16 sm:px-6 lg:px-8">
      <h2 class="text-2xl font-bold text-neutral-900 dark:text-white mb-6">About This Product</h2>
      <div class="prose prose-neutral dark:prose-invert max-w-none">
        <p class="text-neutral-600 dark:text-neutral-300 text-lg leading-relaxed">
          {product.content}
        </p>
      </div>
    </section>
  )}

  <!-- Size Guide -->
  <section class="bg-neutral-50 dark:bg-neutral-800/50">
    <div class="mx-auto max-w-4xl px-4 py-16 sm:px-6 lg:px-8">
      <h2 class="text-2xl font-bold text-neutral-900 dark:text-white mb-6">Size Guide</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-neutral-200 dark:border-neutral-700">
              <th class="px-4 py-3 text-left font-semibold text-neutral-900 dark:text-white">UK Size</th>
              <th class="px-4 py-3 text-left font-semibold text-neutral-900 dark:text-white">US Size</th>
              <th class="px-4 py-3 text-left font-semibold text-neutral-900 dark:text-white">EU Size</th>
              <th class="px-4 py-3 text-left font-semibold text-neutral-900 dark:text-white">Foot Length (cm)</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-neutral-200 dark:divide-neutral-700">
            <tr><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">7</td><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">8</td><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">41</td><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">25.4</td></tr>
            <tr><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">8</td><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">9</td><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">42</td><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">26.0</td></tr>
            <tr><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">9</td><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">10</td><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">43</td><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">26.7</td></tr>
            <tr><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">10</td><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">11</td><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">44</td><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">27.3</td></tr>
            <tr><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">11</td><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">12</td><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">45</td><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">28.0</td></tr>
            <tr><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">12</td><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">13</td><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">46</td><td class="px-4 py-3 text-neutral-600 dark:text-neutral-300">28.6</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</MainLayout>

<script>
  import { addCartItem } from "@stores/cartStore";

  // Thumbnail gallery click
  document.querySelectorAll('.thumbnail-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const imageUrl = btn.getAttribute('data-image');
      const mainImage = document.getElementById('main-product-image') as HTMLImageElement;
      if (mainImage && imageUrl) {
        mainImage.src = imageUrl;
      }
      // Update active state
      document.querySelectorAll('.thumbnail-btn').forEach(b => {
        b.classList.remove('border-orange-500', 'opacity-100');
        b.classList.add('border-transparent', 'opacity-70');
      });
      btn.classList.add('border-orange-500', 'opacity-100');
      btn.classList.remove('border-transparent', 'opacity-70');
    });
  });

  // Size selection
  let selectedSize = '';
  document.querySelectorAll('.size-btn').forEach((btn, index) => {
    if (index === 0) selectedSize = btn.getAttribute('data-size') || '';
    btn.addEventListener('click', () => {
      selectedSize = btn.getAttribute('data-size') || '';
      document.querySelectorAll('.size-btn').forEach(b => {
        b.classList.remove('border-orange-500', 'bg-orange-50', 'text-orange-700', 'dark:bg-orange-900/20', 'dark:text-orange-400');
        b.classList.add('border-neutral-200', 'text-neutral-700', 'dark:border-neutral-600', 'dark:text-neutral-300');
      });
      btn.classList.add('border-orange-500', 'bg-orange-50', 'text-orange-700', 'dark:bg-orange-900/20', 'dark:text-orange-400');
      btn.classList.remove('border-neutral-200', 'text-neutral-700', 'dark:border-neutral-600', 'dark:text-neutral-300');
    });
  });

  // Add to cart
  const addToCartBtn = document.getElementById('add-to-cart');
  addToCartBtn?.addEventListener('click', () => {
    const productId = addToCartBtn.getAttribute('data-product-id');
    const productTitle = addToCartBtn.getAttribute('data-product-title');
    const productPrice = parseFloat(addToCartBtn.getAttribute('data-product-price') || '0');
    const productImage = addToCartBtn.getAttribute('data-product-image');

    if (!selectedSize) {
      alert('Please select a size');
      return;
    }

    addCartItem({
      id: `${productId}-${selectedSize}`,
      name: productTitle || 'Product',
      price: productPrice,
      quantity: 1,
      size: selectedSize,
      image: productImage || '',
    });

    alert('Added to cart!');
  });
</script>
