---
import MainLayout from "@/layouts/MainLayout.astro";
import { SITE } from "@data/constants";

const pageTitle = `Site Settings | Admin Dashboard`;
---

<MainLayout title={pageTitle}>
  <div id="auth-loading" class="flex min-h-[60vh] items-center justify-center">
    <div class="text-center">
      <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-orange-500 border-t-transparent"></div>
      <p class="mt-4 text-neutral-600 dark:text-neutral-400">Checking authentication...</p>
    </div>
  </div>

  <div id="admin-content" class="hidden">
    <section class="mx-auto max-w-[85rem] px-4 py-10 sm:px-6 lg:px-8 lg:py-14">
      <div class="mb-8">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white sm:text-3xl">Site Settings</h1>
            <p class="mt-1 text-sm text-gray-500 dark:text-neutral-400">Manage global website information and social links</p>
          </div>
          <a href="/admin" class="inline-flex items-center gap-x-2 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-800 shadow-sm hover:bg-gray-50 dark:border-neutral-700 dark:bg-neutral-800 dark:text-white dark:hover:bg-neutral-700">
            Back to Orders
          </a>
        </div>
      </div>

      <div class="grid gap-8 lg:grid-cols-3">
        <!-- Main Form -->
        <div class="lg:col-span-2">
          <form id="settings-form" class="space-y-6 rounded-xl border border-gray-200 bg-white p-6 shadow-sm dark:border-neutral-700 dark:bg-neutral-800">
            <div class="grid gap-6 sm:grid-cols-2">
              <div class="sm:col-span-2">
                <label for="favicon_url" class="mb-2 block text-sm font-medium text-gray-800 dark:text-white">Favicon URL</label>
                <input type="text" id="favicon_url" name="favicon_url" class="block w-full rounded-lg border-gray-200 px-4 py-3 text-sm focus:border-orange-500 focus:ring-orange-500 dark:border-neutral-700 dark:bg-neutral-900 dark:text-neutral-400" placeholder="/favicon.png">
                <p class="mt-2 text-xs text-gray-500">Path to your favicon image (e.g., /favicon.png)</p>
              </div>

              <div>
                <label for="phone_number" class="mb-2 block text-sm font-medium text-gray-800 dark:text-white">Phone Number</label>
                <input type="text" id="phone_number" name="phone_number" class="block w-full rounded-lg border-gray-200 px-4 py-3 text-sm focus:border-orange-500 focus:ring-orange-500 dark:border-neutral-700 dark:bg-neutral-900 dark:text-neutral-400">
              </div>

              <div>
                <label for="email_address" class="mb-2 block text-sm font-medium text-gray-800 dark:text-white">Email Address</label>
                <input type="email" id="email_address" name="email_address" class="block w-full rounded-lg border-gray-200 px-4 py-3 text-sm focus:border-orange-500 focus:ring-orange-500 dark:border-neutral-700 dark:bg-neutral-900 dark:text-neutral-400">
              </div>

              <div class="sm:col-span-2">
                <label for="physical_address" class="mb-2 block text-sm font-medium text-gray-800 dark:text-white">Physical Address</label>
                <textarea id="physical_address" name="physical_address" rows="2" class="block w-full rounded-lg border-gray-200 px-4 py-3 text-sm focus:border-orange-500 focus:ring-orange-500 dark:border-neutral-700 dark:bg-neutral-900 dark:text-neutral-400"></textarea>
              </div>

              <div class="sm:col-span-2 border-t pt-6 dark:border-neutral-700">
                <h3 class="mb-4 text-lg font-semibold text-gray-800 dark:text-white">Social Links</h3>
              </div>

              <div>
                <label for="facebook_url" class="mb-2 block text-sm font-medium text-gray-800 dark:text-white">Facebook URL</label>
                <input type="url" id="facebook_url" name="facebook_url" class="block w-full rounded-lg border-gray-200 px-4 py-3 text-sm focus:border-orange-500 focus:ring-orange-500 dark:border-neutral-700 dark:bg-neutral-900 dark:text-neutral-400">
              </div>

              <div>
                <label for="instagram_url" class="mb-2 block text-sm font-medium text-gray-800 dark:text-white">Instagram URL</label>
                <input type="url" id="instagram_url" name="instagram_url" class="block w-full rounded-lg border-gray-200 px-4 py-3 text-sm focus:border-orange-500 focus:ring-orange-500 dark:border-neutral-700 dark:bg-neutral-900 dark:text-neutral-400">
              </div>

              <div>
                <label for="whatsapp_number" class="mb-2 block text-sm font-medium text-gray-800 dark:text-white">WhatsApp Number (e.g., 923001234567)</label>
                <input type="text" id="whatsapp_number" name="whatsapp_number" class="block w-full rounded-lg border-gray-200 px-4 py-3 text-sm focus:border-orange-500 focus:ring-orange-500 dark:border-neutral-700 dark:bg-neutral-900 dark:text-neutral-400">
              </div>
            </div>

            <div class="mt-8 flex justify-end">
              <button type="submit" id="save-btn" class="inline-flex items-center gap-x-2 rounded-lg border border-transparent bg-orange-500 px-6 py-3 text-sm font-semibold text-white hover:bg-orange-600 disabled:opacity-50">
                Save Settings
              </button>
            </div>
          </form>
        </div>

        <!-- Sidebar Info -->
        <div class="space-y-6">
          <div class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm dark:border-neutral-700 dark:bg-neutral-800">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Live Preview</h3>
            <p class="text-sm text-gray-500 dark:text-neutral-400 mb-4">These values are used across the entire site including footer, contact page, and meta tags.</p>
            <div class="space-y-3 p-4 bg-gray-50 rounded-lg dark:bg-neutral-900/50">
              <div class="flex items-center gap-2">
                <span class="text-xs font-bold uppercase text-gray-400">Favicon:</span>
                <img id="preview-favicon" src="/favicon.png" class="h-6 w-6 rounded border bg-white" />
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</MainLayout>

<script>
  import { $user } from "@stores/authStore";

  const form = document.getElementById('settings-form') as HTMLFormElement;
  const authLoading = document.getElementById('auth-loading');
  const adminContent = document.getElementById('admin-content');
  const saveBtn = document.getElementById('save-btn') as HTMLButtonElement;

  // Initialize page
  document.addEventListener('DOMContentLoaded', async () => {
    const user = $user.get();
    if (!user || user.role !== 'admin') {
      window.location.href = '/login';
      return;
    }

    authLoading?.classList.add('hidden');
    adminContent?.classList.remove('hidden');

    await loadSettings();
  });

  async function loadSettings() {
    try {
      const response = await fetch('/api/admin/settings');
      const data = await response.json();

      if (response.ok && data.settings) {
        Object.entries(data.settings).forEach(([key, value]) => {
          const input = document.getElementById(key) as HTMLInputElement | HTMLTextAreaElement;
          if (input) {
            input.value = value as string;
            if (key === 'favicon_url') {
              (document.getElementById('preview-favicon') as HTMLImageElement).src = value as string;
            }
          }
        });
      }
    } catch (error) {
      console.error('Error loading settings:', error);
    }
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    saveBtn.disabled = true;
    saveBtn.innerText = 'Saving...';

    const formData = new FormData(form);
    const settings = Object.fromEntries(formData.entries());

    try {
      const response = await fetch('/api/admin/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ settings }),
      });

      if (response.ok) {
        alert('Settings saved successfully!');
        if (settings.favicon_url) {
            (document.getElementById('preview-favicon') as HTMLImageElement).src = settings.favicon_url as string;
        }
      } else {
        alert('Failed to save settings.');
      }
    } catch (error) {
      console.error('Error saving settings:', error);
      alert('An error occurred while saving.');
    } finally {
      saveBtn.disabled = false;
      saveBtn.innerText = 'Save Settings';
    }
  });
</script>
