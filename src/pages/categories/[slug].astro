---
// Import necessary components
import MainLayout from "@/layouts/MainLayout.astro";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { SITE } from "@data/constants";

// 1. Generate a new path for every collection entry
export async function getStaticPaths() {
  const categories = [
    {
      slug: "zalmi",
      title: "Zalmi Collection",
      description: "Modern and stylish Zalmi Chappals, perfect for the contemporary fashion statement."
    },
    {
      slug: "norozi",
      title: "Norozi Collection",
      description: "Rugged and robust with a thick tire sole. Built for durability and tough terrain."
    },
    {
      slug: "panjedar",
      title: "Panjedar Collection",
      description: "Distinctive open-toe design with intricate stitching. A unique style statement."
    },
    {
      slug: "charsadda",
      title: "Charsadda Collection",
      description: "Simple, lightweight, and stylish. A perfect blend of tradition and casual wear."
    },
    {
      slug: "peshawari-chappal",
      title: "Peshawari Chappal",
      description: "The timeless classic. Hand-stitched leather sandals known for their elegance and comfort."
    }
  ];

  return categories.map((category) => ({
    params: { slug: category.slug },
    props: { category },
  }));
}

// 2. Get the category prop
const { category } = Astro.props;

// 3. Fetch and filter products
const allProducts = await getCollection("products", ({ id }) => id.startsWith("en/"));

// Match products by category field (case-insensitive) or title if category is missing
let products = allProducts.filter((product) => {
  const productCategory = product.data.category?.toLowerCase();
  const slug = category.slug.toLowerCase();
  
  // Direct category match
  if (productCategory === slug) return true;
  
  // Special handling for "peshawari-chappal" slug to include general products or specific ones
  if (slug === 'peshawari-chappal' && !productCategory) return true;
  
  // Fallback to title check if no category is assigned
  if (!productCategory && product.data.title.toLowerCase().includes(slug)) return true;
  
  return false;
});

const pageTitle = `${category.title} | ${SITE.title}`;
---

<MainLayout
  title={pageTitle}
  customDescription={category.description}
>
  <section class="mx-auto max-w-[85rem] px-4 py-10 sm:px-6 lg:px-8 lg:py-14 2xl:max-w-full">
    <div class="mb-4 flex items-center justify-between gap-8 sm:mb-8 md:mb-12">
      <div class="flex items-center gap-12">
        <h1 class="text-2xl font-bold tracking-tight text-balance text-neutral-800 md:text-4xl md:leading-tight dark:text-neutral-200">
          {category.title}
        </h1>
        <p class="hidden max-w-xl text-pretty text-neutral-600 md:block dark:text-neutral-400">
          {category.description}
        </p>
      </div>
    </div>

    {products.length > 0 ? (
      <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-4">
        {products.map((product) => (
          <a href={`/products/${product.id.replace(/^en\//, "")}`} class="group relative bg-white dark:bg-neutral-800 rounded-2xl overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300">
            <div class="aspect-square overflow-hidden">
              <img 
                src={typeof product.data.main.imgCard === 'string' ? product.data.main.imgCard : product.data.main.imgCard.src}
                alt={product.data.main.imgAlt}
                class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
              />
            </div>
            <div class="p-5">
              <h3 class="text-lg font-bold text-neutral-800 dark:text-neutral-200 group-hover:text-yellow-600 dark:group-hover:text-yellow-500 transition-colors">
                {product.data.title}
              </h3>
              <p class="text-sm text-neutral-600 dark:text-neutral-400 mt-1 line-clamp-2">{product.data.description}</p>
              <div class="mt-4 flex items-center justify-between">
                <div class="flex flex-col">
                  <span class="text-lg font-bold text-neutral-900 dark:text-white">₨ {(product.data.main.price || 5500).toLocaleString()}</span>
                  {product.data.main.originalPrice && (
                    <span class="text-xs text-neutral-500 line-through">₨ {product.data.main.originalPrice.toLocaleString()}</span>
                  )}
                </div>
                <span class="text-yellow-600 dark:text-yellow-500 font-bold text-sm">View Details</span>
              </div>
            </div>
          </a>
        ))}
      </div>
    ) : (
      <div class="py-20 text-center">
        <div class="mb-4 rounded-full bg-neutral-100 p-4 inline-flex dark:bg-neutral-800">
          <svg class="h-10 w-10 text-neutral-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-neutral-800 dark:text-neutral-200">
          No products found
        </h3>
        <p class="mt-2 text-neutral-600 dark:text-neutral-400">
          We couldn't find any products in this collection.
        </p>
        <a href="/products" class="mt-6 inline-flex items-center gap-x-2 rounded-lg border border-transparent bg-orange-600 px-4 py-3 text-sm font-semibold text-white hover:bg-orange-700 disabled:opacity-50 disabled:pointer-events-none">
          View all products
        </a>
      </div>
    )}
  </section>
</MainLayout>
