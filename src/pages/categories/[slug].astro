---
// Import necessary components
import MainLayout from "@/layouts/MainLayout.astro";
import { SITE } from "@data/constants";
import { supabase } from "@/lib/db";

// Make this page dynamic instead of static
export const prerender = false;

// Get the slug from the URL
const { slug } = Astro.params;

// Fetch the category from Supabase
const { data: categoryData } = await supabase
  .from('categories')
  .select('*')
  .eq('slug', slug)
  .single();

// If category not found, handle it
if (!categoryData) {
  return new Response('Category not found', { status: 404 });
}

const category = {
  id: categoryData.id,
  slug: categoryData.slug,
  title: categoryData.name,
  description: categoryData.description
};

// Fetch products for this category by name
const { data: products } = await supabase
  .from('products')
  .select('*')
  .eq('category', category.title);

const pageTitle = `${category.title} | ${SITE.title}`;
---

<MainLayout
  title={pageTitle}
  customDescription={category.description}
>
  <section class="mx-auto max-w-[85rem] px-4 py-10 sm:px-6 lg:px-8 lg:py-14 2xl:max-w-full">
    <div class="mb-4 flex items-center justify-between gap-8 sm:mb-8 md:mb-12">
      <div class="flex items-center gap-12">
        <h1 class="text-2xl font-bold tracking-tight text-balance text-neutral-800 md:text-4xl md:leading-tight dark:text-neutral-200">
          {category.title}
        </h1>
        <p class="hidden max-w-xl text-pretty text-neutral-600 md:block dark:text-neutral-400">
          {category.description}
        </p>
      </div>
    </div>

    {products && products.length > 0 ? (
      <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-4">
        {products.map((product: any) => (
          <a href={`/products/${product.slug}`} class="group relative bg-white dark:bg-neutral-800 rounded-2xl overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300">
            <div class="aspect-square overflow-hidden">
              <img 
                src={product.card_image || product.main_image || "https://via.placeholder.com/300"}
                alt={product.title}
                class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
              />
            </div>
            <div class="p-5">
              <h3 class="text-lg font-bold text-neutral-800 dark:text-neutral-200 group-hover:text-yellow-600 dark:group-hover:text-yellow-500 transition-colors">
                {product.title}
              </h3>
              <p class="text-sm text-neutral-600 dark:text-neutral-400 mt-1 line-clamp-2">{product.long_description || product.description}</p>
              <div class="mt-4 flex items-center justify-between">
                <div class="flex flex-col">
                  <span class="text-lg font-bold text-neutral-900 dark:text-white">₨ {parseInt(product.price).toLocaleString()}</span>
                  {product.original_price && (
                    <span class="text-xs text-neutral-500 line-through">₨ {parseInt(product.original_price).toLocaleString()}</span>
                  )}
                </div>
                <span class="text-yellow-600 dark:text-yellow-500 font-bold text-sm">View Details</span>
              </div>
            </div>
          </a>
        ))}
      </div>
    ) : (
      <div class="py-20 text-center">
        <div class="mb-4 rounded-full bg-neutral-100 p-4 inline-flex dark:bg-neutral-800">
          <svg class="h-10 w-10 text-neutral-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-neutral-800 dark:text-neutral-200">
          No products found
        </h3>
        <p class="mt-2 text-neutral-600 dark:text-neutral-400">
          We couldn't find any products in this collection.
        </p>
        <a href="/products" class="mt-6 inline-flex items-center gap-x-2 rounded-lg border border-transparent bg-orange-600 px-4 py-3 text-sm font-semibold text-white hover:bg-orange-700 disabled:opacity-50 disabled:pointer-events-none">
          View all products
        </a>
      </div>
    )}
  </section>
</MainLayout>
