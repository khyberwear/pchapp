---
// Import the necessary components from their respective component files
import LoginBtn from "@components/ui/buttons/LoginBtn.astro";
---

<div id="auth-container" class="hidden md:flex items-center">
  <!-- Login Button (Default) -->
  <div id="login-btn-container">
    <LoginBtn />
  </div>

  <!-- User Menu (Hidden by default) -->
  <div id="user-menu-container" class="hidden relative inline-flex">
    <button
      id="user-menu-btn"
      type="button"
      class="inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent text-gray-800 hover:bg-gray-100 disabled:opacity-50 disabled:pointer-events-none dark:text-white dark:hover:bg-neutral-700 dark:focus:outline-none dark:focus:ring-1 dark:focus:ring-gray-600"
    >
      <span id="user-name" class="font-medium">User</span>
      <svg class="hs-dropdown-open:rotate-180 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
    </button>

    <div
      id="user-dropdown"
      class="hidden absolute right-0 top-full mt-2 min-w-[15rem] bg-white shadow-md rounded-lg p-2 dark:bg-neutral-800 dark:border dark:border-neutral-700 z-[9999]"
    >
      <a class="flex items-center gap-x-3.5 py-2 px-3 rounded-lg text-sm text-gray-800 hover:bg-gray-100 focus:outline-none focus:bg-gray-100 dark:text-neutral-400 dark:hover:bg-neutral-700 dark:hover:text-neutral-300 dark:focus:bg-neutral-700" href="/settings">
        Settings
      </a>
      <a id="admin-link" class="hidden flex items-center gap-x-3.5 py-2 px-3 rounded-lg text-sm text-gray-800 hover:bg-gray-100 focus:outline-none focus:bg-gray-100 dark:text-neutral-400 dark:hover:bg-neutral-700 dark:hover:text-neutral-300 dark:focus:bg-neutral-700" href="/admin">
        Admin Dashboard
      </a>
      <button
        id="logout-btn"
        class="w-full flex items-center gap-x-3.5 py-2 px-3 rounded-lg text-sm text-red-600 hover:bg-gray-100 focus:outline-none focus:bg-gray-100 dark:text-red-500 dark:hover:bg-neutral-700 dark:focus:bg-neutral-700"
      >
        Logout
      </button>
    </div>
  </div>
</div>

<script>
  import { $user, logout } from "@stores/authStore";

  const loginContainer = document.getElementById("login-btn-container");
  const userContainer = document.getElementById("user-menu-container");
  const userNameSpan = document.getElementById("user-name");
  const adminLink = document.getElementById("admin-link");
  const userMenuBtn = document.getElementById("user-menu-btn");
  const userDropdown = document.getElementById("user-dropdown");
  const logoutBtn = document.getElementById("logout-btn");

  // Toggle dropdown
  userMenuBtn?.addEventListener("click", (e) => {
    e.stopPropagation();
    if (userDropdown?.classList.contains("hidden")) {
      userDropdown?.classList.remove("hidden");
      userDropdown?.classList.add("flex", "flex-col");
    } else {
      userDropdown?.classList.add("hidden");
      userDropdown?.classList.remove("flex", "flex-col");
    }
  });

  // Close dropdown when clicking outside
  document.addEventListener("click", (e) => {
    if (userContainer && !userContainer.contains(e.target as Node)) {
      userDropdown?.classList.add("hidden");
      userDropdown?.classList.remove("flex", "flex-col");
    }
  });

  // Handle Logout
  logoutBtn?.addEventListener("click", () => {
    logout();
    window.location.href = "/";
  });

  // Subscribe to user state
  $user.subscribe((user) => {
    if (user) {
      loginContainer?.classList.add("hidden");
      userContainer?.classList.remove("hidden");
      if (userNameSpan) userNameSpan.textContent = user.name;
      
      if (user.role === 'admin') {
        adminLink?.classList.remove("hidden");
      } else {
        adminLink?.classList.add("hidden");
      }
    } else {
      loginContainer?.classList.remove("hidden");
      userContainer?.classList.add("hidden");
    }
  });
</script>
