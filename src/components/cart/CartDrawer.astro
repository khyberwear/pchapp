---
---

<div
  id="cart-drawer"
  class="hs-overlay fixed end-0 top-0 z-[60] hidden h-full w-full max-w-md translate-x-full transform border-s bg-white transition-all duration-300 hs-overlay-open:translate-x-0 dark:border-neutral-700 dark:bg-neutral-800"
  tabindex="-1"
>
  <div class="flex h-full flex-col">
    <div class="flex items-center justify-between border-b px-4 py-3 dark:border-neutral-700">
      <h3 class="font-bold text-gray-800 dark:text-white">Shopping Cart</h3>
      <button
        type="button"
        class="flex h-7 w-7 items-center justify-center rounded-full border border-transparent text-sm font-semibold text-gray-800 hover:bg-gray-100 disabled:opacity-50 disabled:pointer-events-none dark:text-white dark:hover:bg-neutral-700 dark:focus:outline-none dark:focus:ring-1 dark:focus:ring-gray-600"
        data-hs-overlay="#cart-drawer"
      >
        <span class="sr-only">Close modal</span>
        <svg
          class="h-4 w-4"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M18 6 6 18"></path>
          <path d="m6 6 12 12"></path>
        </svg>
      </button>
    </div>

    <div class="h-full overflow-y-auto p-4">
      <div id="cart-items" class="space-y-4">
        <!-- Cart items will be injected here -->
        <p class="text-center text-gray-500 dark:text-gray-400">Your cart is empty.</p>
      </div>
    </div>

    <div class="border-t p-4 dark:border-neutral-700">
      <div class="mb-4 flex justify-between text-lg font-bold text-gray-800 dark:text-white">
        <span>Total</span>
        <span id="cart-total">Rs 0.00</span>
      </div>
      <a
        href="/checkout"
        class="inline-flex w-full items-center justify-center gap-x-2 rounded-lg border border-transparent bg-orange-500 px-4 py-3 text-sm font-semibold text-white hover:bg-orange-600 disabled:opacity-50 disabled:pointer-events-none dark:focus:outline-none dark:focus:ring-1 dark:focus:ring-gray-600"
      >
        Checkout
      </a>
    </div>
  </div>
</div>

<script>
  import { $cart, removeFromCart } from "@stores/cartStore";

  const cartItemsContainer = document.getElementById("cart-items");
  const cartTotalElement = document.getElementById("cart-total");

  $cart.subscribe((cart) => {
    if (!cartItemsContainer || !cartTotalElement) return;

    const items = Object.values(cart);
    
    if (items.length === 0) {
      cartItemsContainer.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">Your cart is empty.</p>';
      cartTotalElement.textContent = "Rs 0.00";
      return;
    }

    let total = 0;
    cartItemsContainer.innerHTML = items.map((item) => {
      total += item.price * item.quantity;
      return `
        <div class="flex gap-x-4 rounded-lg border p-3 dark:border-neutral-700">
          <div class="flex-1 min-w-0">
            <h4 class="text-sm font-medium text-gray-800 dark:text-white truncate">${item.title}</h4>
            <p class="text-sm font-semibold text-gray-800 dark:text-white">Rs ${(item.price * item.quantity).toFixed(2)}</p>
            
            <!-- Quantity Controls -->
            <div class="flex items-center gap-2 mt-2">
              <button 
                data-id="${item.id}" 
                class="decrease-btn flex h-6 w-6 items-center justify-center rounded border border-gray-300 text-xs hover:bg-gray-50 dark:border-neutral-600 dark:hover:bg-neutral-700"
              >
                -
              </button>
              <span class="text-sm font-medium text-gray-800 dark:text-white min-w-[2rem] text-center">${item.quantity}</span>
              <button 
                data-id="${item.id}" 
                class="increase-btn flex h-6 w-6 items-center justify-center rounded border border-gray-300 text-xs hover:bg-gray-50 dark:border-neutral-600 dark:hover:bg-neutral-700"
              >
                +
              </button>
            </div>
          </div>
          <button 
            data-id="${item.id}" 
            class="remove-btn text-sm text-red-600 hover:text-red-800 dark:text-red-500 dark:hover:text-red-400 self-start"
          >
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        </div>
      `;
    }).join("");

    cartTotalElement.textContent = `Rs ${total.toFixed(2)}`;

    // Add event listeners to remove buttons
    document.querySelectorAll(".remove-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const button = (e.target as HTMLElement).closest('.remove-btn') as HTMLElement;
        const id = button?.dataset.id;
        if (id) removeFromCart(id);
      });
    });

    // Add event listeners to quantity buttons
    document.querySelectorAll(".increase-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const button = (e.target as HTMLElement).closest('.increase-btn') as HTMLElement;
        const id = button?.dataset.id;
        if (id) {
          const cart = $cart.get();
          const item = cart[id];
          if (item) {
            $cart.setKey(id, { ...item, quantity: item.quantity + 1 });
          }
        }
      });
    });

    document.querySelectorAll(".decrease-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const button = (e.target as HTMLElement).closest('.decrease-btn') as HTMLElement;
        const id = button?.dataset.id;
        if (id) {
          const cart = $cart.get();
          const item = cart[id];
          if (item) {
            if (item.quantity > 1) {
              $cart.setKey(id, { ...item, quantity: item.quantity - 1 });
            } else {
              removeFromCart(id);
            }
          }
        }
      });
    });
  });
</script>
